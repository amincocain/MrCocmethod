#!/bin/bash

# Configuration Paths
CONF_FILE="/etc/gre_tunnel_config.sh"
MONITOR_FILE="/usr/local/bin/gre_monitor.sh"
VARS_FILE="/etc/gre_vars.conf"
TG_CONF="/etc/gre_tg.conf"

show_menu() {
    echo -e "\n\e[1;34m--- Modiriate Tunnel GRE (Pishrafte) ---\e[0m"
    echo "1) Sakht e Tunnel va Port Forwarding (Iran be Kharej)"
    echo "2) Tanzimate Telegram (Baraye Ettela-resani)"
    echo "3) Faal-sazi e Mandegari va Monitoring (Auto-Run)"
    echo "4) Taghyire MTU dar Tunnel-haye Mojood"
    echo "5) Namayeshe Vaziat e Tunnel-ha va Port-ha"
    echo -e " \e[1;31m6) TEST PACKET LOSS (Unlimited Test)\e[0m" # Ø¹Ù†ÙˆØ§Ù† Ù‚Ø±Ù…Ø² Ø±Ù†Ú¯
    echo "7) Pak-sazi va Hazfe Kamel e Tanzimat"
    echo "8) Khorooj"
    echo -e "\e[1;33m----------------------------------------\e[0m"
    read -p "Lotfan yek gozine entekhab konid [1-8]: " choice
}

test_connection() {
    while true; do
        echo -e "\n\e[1;31m--- TEST PACKET LOSS ---\e[0m"
        read -p "IPv4 Server e KHAREJ ro vared konid (ya baraye bargasht be menu benevisid 'exit'): " test_ip
        
        if [[ "$test_ip" == "exit" ]]; then
            break
        fi

        echo -e "\e[1;33mDar hal e check kardane 20 pcket... Lotfan sabr konid...\e[0m"
        
        # Ejraye ping dar pas-zamine
        ping -c 20 -q $test_ip > /tmp/ping_result.txt &
        pid=$!
        
        # Animation e Loading
        spin='-\|/'
        while kill -0 $pid 2>/dev/null; do
            i=$(( (i+1) %4 ))
            printf "\r${spin:$i:1} Dar hale Test kardan..."
            sleep 0.2
        done
        printf "\r"

        # Estekhraje natije
        if [ -s /tmp/ping_result.txt ]; then
            loss=$(grep -oP '\d+(?=% packet loss)' /tmp/ping_result.txt)
            latency=$(grep -oP 'rtt min/avg/max/mdev = \d+\.\d+/\K\d+\.\d+' /tmp/ping_result.txt)

            echo -e "\n\e[1;35m--- NATIJE TEST baraye $test_ip ---\e[0m"
            if [ "$loss" -eq 0 ]; then
                echo -e "\e[1;32mâœ… Packet Loss: $loss% (Etesal Ali hast)\e[0m"
            elif [ "$loss" -lt 20 ]; then
                echo -e "\e[1;33mâš ï¸ Packet Loss: $loss% (Etesal ba ekhtelal)\e[0m"
            else
                echo -e "\e[1;31mâŒ Packet Loss: $loss% (Etesal Kheili Zaeef)\e[0m"
            fi
            echo -e "\e[1;34mðŸ“Š Latency: $latency ms\e[0m"
        else
            echo -e "\e[1;31mâŒ Khata: IP na-motabar ast ya Server javab nemideh!\e[0m"
        fi
        echo "----------------------------------------"
    done
    rm /tmp/ping_result.txt 2>/dev/null
}

# --- Baghiye function-ha (setup_tunnel, change_mtu, setup_telegram, etc.) bedune taghyir mimanand ---

# ... [Kode baghiye bakhsh-ha ke dar pasokh-haye ghabli bud ro inja gharar bedid] ...

# MAIN LOOP
while true; do
    show_menu
    case $choice in
        1) setup_tunnel ;;
        2) setup_telegram ;;
        3) make_persistent ;;
        4) change_mtu ;;
        5) 
            echo -e "\n--- Vaziat e Tunnel-ha va MTU ---"
            ip -d link show type gre | grep -E 'mtu|gre'
            echo "--- Port-haye Forward shode (NAT) ---"
            iptables -t nat -L PREROUTING -n -v
            ;;
        6) test_connection ;;
        7) uninstall ;;
        8) echo "Khoda-fez!"; exit 0 ;;
        *) echo -e "\e[1;31mGozine eshtebah ast!\e[0m" ;;
    esac
done
