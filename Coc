#!/bin/bash

# مسیرهای ذخیره‌سازی فایل‌های کانفیگ
CONF_FILE="/etc/gre_tunnel_config.sh"
MONITOR_FILE="/usr/local/bin/gre_monitor.sh"
VARS_FILE="/etc/gre_vars.conf"
TG_CONF="/etc/gre_tg.conf"

show_menu() {
    echo -e "\n\e[1;34m--- مدیریت پیشرفته تونل GRE (نسخه فارسی) ---\e[0m"
    echo "1) ساخت تونل و فوروارد پورت (اتصال به سرور خارج)"
    echo "2) تنظیمات اطلاع‌رسانی تلگرام (توکن و چت‌آیدی)"
    echo "3) فعال‌سازی ماندگاری و مانیتورینگ (اجرا در استارتاپ)"
    echo "4) مشاهده وضعیت لحظه‌ای تونل‌ها و پورت‌ها"
    echo "5) حذف کامل تنظیمات و توقف مانیتورینگ"
    echo "6) خروج"
    echo -e "\e[1;33m-------------------------------------------\e[0m"
    read -p "لطفاً یک گزینه را انتخاب کنید [1-6]: " choice
}

setup_tunnel() {
    read -p "شماره تونل را وارد کنید (مثلاً 1 یا 2): " num
    read -p "آی‌پی این سرور (ایران): " localip
    read -p "آی‌پی سرور خارج (مقصد): " remoteip
    read -p "آی‌پی داخلی دلخواه برای تونل (پیشنهادی: 10.0.$num.1): " tunnelip
    read -p "پورت‌های مورد نظر را وارد کنید (با کاما جدا کنید، مثلاً 80,443,2082): " ports

    # ساخت اینترفیس GRE
    ip tunnel add gre$num mode gre remote $remoteip local $localip ttl 255
    ip link set gre$num up
    ip addr add $tunnelip/30 dev gre$num
    ip link set dev gre$num mtu 1436
    
    # فعال‌سازی فورواردینگ سیستم
    sysctl -w net.ipv4.ip_forward=1 > /dev/null

    # تنظیم پورت‌ها در IPTables
    IFS=',' read -ra ADDR <<< "$ports"
    for port in "${ADDR[@]}"; do
        iptables -t nat -A PREROUTING -p tcp --dport $port -j DNAT --to-destination $tunnelip
        iptables -t nat -A PREROUTING -p udp --dport $port -j DNAT --to-destination $tunnelip
    done
    iptables -t nat -A POSTROUTING -d $tunnelip -j MASQUERADE

    # ذخیره اطلاعات برای استفاده در مانیتورینگ و استارتاپ
    echo "ip tunnel add gre$num mode gre remote $remoteip local $localip ttl 255" >> $CONF_FILE
    echo "ip link set gre$num up" >> $CONF_FILE
    echo "ip addr add $tunnelip/30 dev gre$num" >> $CONF_FILE
    echo "ip link set dev gre$num mtu 1436" >> $CONF_FILE
    echo "REMOTE_IP_$num=$remoteip" >> $VARS_FILE
    
    echo -e "\e[1;32m✅ تونل شماره $num با موفقیت راه‌اندازی و ذخیره شد.\e[0m"
}

setup_telegram() {
    read -p "توکن ربات تلگرام (Bot Token): " token
    read -p "شناسه چت تلگرام (Chat ID): " chatid
    echo "TG_TOKEN=\"$token\"" > $TG_CONF
    echo "TG_CHATID=\"$chatid\"" >> $TG_CONF
    echo -e "\e[1;32m✅ تنظیمات تلگرام با موفقیت ذخیره شد.\e[0m"
}

make_persistent() {
    echo "در حال آماده‌سازی سرویس‌های سیستمی..."
    
    # ساخت اسکریپت مانیتورینگ
    cat <<'EOF' > $MONITOR_FILE
#!/bin/bash
[ -f /etc/gre_tg.conf ] && source /etc/gre_tg.conf
[ -f /etc/gre_vars.conf ] && source /etc/gre_vars.conf

check_and_notify() {
    IP=$1
    NAME=$2
    ping -c 3 $IP > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        MESSAGE="⚠️ هشدار! اتصال به $NAME (آی‌پی: $IP) قطع شده است."
        curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHATID&text=$MESSAGE"
    fi
}

[ ! -z "$REMOTE_IP_1" ] && check_and_notify "$REMOTE_IP_1" "سرور خارج اول"
[ ! -z "$REMOTE_IP_2" ] && check_and_notify "$REMOTE_IP_2" "سرور خارج دوم"
EOF
    chmod +x $MONITOR_FILE

    # ساخت اسکریپت استارتاپ
    echo "#!/bin/bash" > /usr/local/bin/gre_startup.sh
    echo "sysctl -w net.ipv4.ip_forward=1" >> /usr/local/bin/gre_startup.sh
    [ -f $CONF_FILE ] && cat $CONF_FILE >> /usr/local/bin/gre_startup.sh
    echo "iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu" >> /usr/local/bin/gre_startup.sh
    chmod +x /usr/local/bin/gre_startup.sh

    # تنظیم کرون‌جاب برای مانیتورینگ (هر 5 دقیقه)
    (crontab -l 2>/dev/null | grep -v "$MONITOR_FILE" ; echo "*/5 * * * * $MONITOR_FILE") | crontab -

    echo -e "\e[1;32m✅ قابلیت ماندگاری و مانیتورینگ فعال شد.\e[0m"
}

uninstall() {
    echo "در حال حذف تمامی تنظیمات..."
    crontab -l 2>/dev/null | grep -v "$MONITOR_FILE" | crontab - 2>/dev/null
    rm $TG_CONF $VARS_FILE $CONF_FILE $MONITOR_FILE /usr/local/bin/gre_startup.sh 2>/dev/null
    ip link set gre1 down 2>/dev/null; ip tunnel del gre1 2>/dev/null
    ip link set gre2 down 2>/dev/null; ip tunnel del gre2 2>/dev/null
    iptables -F -t nat
    echo -e "\e[1;31m✅ تمامی تنظیمات، سرویس‌ها و قوانین پورت‌ها حذف شدند.\e[0m"
}

# چرخه اصلی برنامه
while true; do
    show_menu
    case $choice in
        1) setup_tunnel ;;
        2) setup_telegram ;;
        3) make_persistent ;;
        4) 
            echo -e "\n--- وضعیت تونل‌ها ---"
            ip tunnel show
            echo "--- قوانین پورت‌ها (NAT) ---"
            iptables -t nat -L PREROUTING -n -v
            ;;
        5) uninstall ;;
        6) exit 0 ;;
        *) echo -e "\e[1;31mگزینه نامعتبر است!\e[0m" ;;
    esac
done
